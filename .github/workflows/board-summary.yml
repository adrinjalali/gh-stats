name: Generate Board Summary

on:
  schedule:
    # Run daily at 5am UTC
    - cron: '0 5 * * *'
  workflow_dispatch:
    inputs:
      users:
        description: 'Comma-separated list of GitHub usernames (leave empty for all)'
        required: false
        default: ''
      lookback_days:
        description: 'Number of days to look back for activity'
        required: false
        default: '14'

env:
  PYTHONPATH: src/github_analytics/board_summary

jobs:
  generate-summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-stats repo
        uses: actions/checkout@v4

      - name: Checkout reports repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.REPORTS_REPO }}
          token: ${{ secrets.REPORTS_REPO_PAT }}
          path: reports-repo

      - name: Restore cached summaries
        run: |
          # Copy existing summaries.json from reports repo if it exists
          if [ -f reports-repo/summaries.json ]; then
            cp reports-repo/summaries.json src/github_analytics/board_summary/summaries.json
            echo "Restored $(wc -l < src/github_analytics/board_summary/summaries.json) lines of cached summaries"
          else
            echo "No cached summaries found, will generate all"
          fi

      - name: Set up pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.39.5
          cache: true

      - name: Install dependencies
        run: pixi install

      - name: Generate board summary reports
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Parse inputs
          USERS="${{ github.event.inputs.users }}"
          LOOKBACK="${{ github.event.inputs.lookback_days }}"

          # Set defaults for scheduled runs
          if [ -z "$LOOKBACK" ]; then
            LOOKBACK="14"
          fi

          # Create output directory with date
          DATE=$(date +%Y-%m-%d)
          OUTPUT_DIR="reports/${DATE}_${LOOKBACK}d"

          # Build command
          CMD="pixi run board-summary"

          if [ -n "$USERS" ]; then
            # Convert comma-separated to space-separated
            USERS_ARGS=$(echo "$USERS" | tr ',' ' ')
            CMD="$CMD $USERS_ARGS"
          fi

          CMD="$CMD --lookback $LOOKBACK --output $OUTPUT_DIR"

          echo "Running: $CMD"
          $CMD

          # Create index.html redirecting to latest combined report
          LATEST=$(ls -t ${OUTPUT_DIR}/board_summary_*_all.html 2>/dev/null | head -1 || \
                   ls -t ${OUTPUT_DIR}/board_summary_*.html 2>/dev/null | head -1)
          if [ -n "$LATEST" ]; then
            LATEST_BASENAME=$(basename "$LATEST")
            LATEST_DIR=$(basename "$(dirname "$LATEST")")
            cat > reports/index.html << HTMLEOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta http-equiv="refresh" content="0; url=${LATEST_DIR}/${LATEST_BASENAME}">
            <title>Redirecting...</title>
          </head>
          <body>
            <p>Redirecting to <a href="${LATEST_DIR}/${LATEST_BASENAME}">latest report</a>...</p>
          </body>
          </html>
          HTMLEOF
            echo "Created index.html pointing to ${LATEST_DIR}/${LATEST_BASENAME}"
          fi

      - name: Copy reports and cleanup old files
        run: |
          # Copy new reports to reports-repo
          cp -r reports/* reports-repo/

          # Copy updated summaries.json to reports repo for caching
          if [ -f src/github_analytics/board_summary/summaries.json ]; then
            cp src/github_analytics/board_summary/summaries.json reports-repo/summaries.json
            echo "Saved summaries.json for future runs"
          fi

          cd reports-repo

          # Cleanup report directories older than 30 days
          echo "Cleaning up old report directories..."
          find . -maxdepth 1 -type d -name "20*_*d" -mtime +30 -print -exec rm -rf {} \; 2>/dev/null || true

          # Configure git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Commit and push
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            DATE=$(date +%Y-%m-%d)
            LOOKBACK="${{ github.event.inputs.lookback_days }}"
            if [ -z "$LOOKBACK" ]; then
              LOOKBACK="14"
            fi
            git commit -m "Board summary reports - ${DATE} (${LOOKBACK} days)"
            git push
          fi
