name: Generate Board Summary

on:
  schedule:
    # Run daily at 5am UTC
    - cron: '0 5 * * *'
  workflow_dispatch:
    inputs:
      users:
        description: 'Comma-separated list of GitHub usernames (leave empty for all)'
        required: false
        default: ''
      lookback_days:
        description: 'Number of days to look back for activity'
        required: false
        default: '14'

env:
  PYTHONPATH: src/github_analytics/board_summary

jobs:
  generate-summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-stats repo
        uses: actions/checkout@v4

      - name: Set up pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.39.5
          cache: true

      - name: Install dependencies
        run: pixi install

      - name: Generate board summary reports
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Parse inputs
          USERS="${{ github.event.inputs.users }}"
          LOOKBACK="${{ github.event.inputs.lookback_days }}"

          # Set defaults for scheduled runs
          if [ -z "$LOOKBACK" ]; then
            LOOKBACK="14"
          fi

          # Create output directory with date
          DATE=$(date +%Y-%m-%d)
          OUTPUT_DIR="reports/${DATE}_${LOOKBACK}d"

          # Build command
          CMD="pixi run board-summary"

          if [ -n "$USERS" ]; then
            # Convert comma-separated to space-separated
            USERS_ARGS=$(echo "$USERS" | tr ',' ' ')
            CMD="$CMD $USERS_ARGS"
          fi

          CMD="$CMD --lookback $LOOKBACK --output $OUTPUT_DIR"

          echo "Running: $CMD"
          $CMD

          # Create index.html pointing to latest combined report
          LATEST=$(ls -t ${OUTPUT_DIR}/board_summary_*_all.html 2>/dev/null | head -1 || \
                   ls -t ${OUTPUT_DIR}/board_summary_*.html 2>/dev/null | head -1)
          if [ -n "$LATEST" ]; then
            cp "$LATEST" reports/index.html
          fi

      - name: Checkout reports repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.REPORTS_REPO }}
          token: ${{ secrets.REPORTS_REPO_PAT }}
          path: reports-repo

      - name: Copy reports and push
        run: |
          # Copy new reports
          cp -r reports/* reports-repo/

          cd reports-repo

          # Configure git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Commit and push
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            DATE=$(date +%Y-%m-%d)
            LOOKBACK="${{ github.event.inputs.lookback_days }}"
            if [ -z "$LOOKBACK" ]; then
              LOOKBACK="14"
            fi
            git commit -m "Board summary reports - ${DATE} (${LOOKBACK} days)"
            git push
          fi
